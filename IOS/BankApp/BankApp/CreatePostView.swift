import SwiftUI
import CoreData

struct CreatePostView: View {
    @Environment(\.presentationMode) var presentationMode
    @Environment(\.managedObjectContext) var viewContext
    
    @FetchRequest(entity: CDUser.entity(), sortDescriptors: []) var users: FetchedResults<CDUser>
    
    @Environment(\.colorScheme) var colorScheme
    
    @State private var selectedAvatar: String = "üë©‚Äçüíª"
    @State private var selectedStatus: String = "–¢—Ä–µ–π–¥–µ—Ä"
    
    @State private var leftCurrency: String = "EUR"
    @State private var rightCurrency: String = "RUB"
    
    @State private var predictionText: String = ""
    @State private var direction: Direction = .up
    @State private var confidence: Double = 70
    @State private var date: Date = Date()
    @State private var showConfirmation = false
    
    let availableAvatars = ["üë©‚Äçüíª", "üßë‚Äçüíº", "üß†", "üìä", "üíπ"]
    let availableStatuses = ["–¢—Ä–µ–π–¥–µ—Ä", "–ê–Ω–∞–ª–∏—Ç–∏–∫", "–ë—Ä–æ–∫–µ—Ä", "–≠–∫—Å–ø–µ—Ä—Ç"]
    let availableCurrencies = ["USD", "EUR", "RUB", "CNY", "JPY", "GBP"]
    
    var availableRightCurrencies: [String] {
        availableCurrencies.filter { $0 != leftCurrency }
    }
    var availableLeftCurrencies: [String] {
        availableCurrencies.filter { $0 != rightCurrency }
    }
    
    var currencyPair: String {
        "\(leftCurrency)/\(rightCurrency)"
    }

    var formattedDate: String {
        let formatter = DateFormatter()
        formatter.locale = Locale(identifier: "ru_RU")
        formatter.dateStyle = .long
        return formatter.string(from: date)
    }

    var currentUser: CDUser? {
        users.first
    }

    var body: some View {
        ZStack {
            LinearGradient(
                gradient: Gradient(colors: [
                    Color(red: 0.06, green: 0.04, blue: 0.15),
                    Color(red: 0.15, green: 0.08, blue: 0.35),
                    Color(red: 0.25, green: 0.13, blue: 0.45)
                ]),
                startPoint: .top,
                endPoint: .bottom
            ).ignoresSafeArea()
            
            ScrollView {
                VStack(spacing: 20) {
                    Group {
                        sectionHeader("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
                        
                        if let user = currentUser {
                            Text("\(user.firstName ?? "") \(user.lastName ?? "")")
                                .font(.title3)
                                .bold()
                                .foregroundColor(.white)
                                .frame(maxWidth: .infinity, alignment: .center)
                                .padding(.leading, 16)
                        } else {
                            Text("–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
                                .foregroundColor(.red)
                                .padding(.leading, 16)
                        }
                        
                        pickerWithLabel("–ê–≤–∞—Ç–∞—Ä", selection: $selectedAvatar, options: availableAvatars)
                        pickerWithLabel("–°—Ç–∞—Ç—É—Å", selection: $selectedStatus, options: availableStatuses)
                    }
                    
                    Group {
                        sectionHeader("–ü—Ä–æ–≥–Ω–æ–∑")
                        
                        VStack(alignment: .leading, spacing: 6) {
                            Text("–í–∞–ª—é—Ç–Ω–∞—è –ø–∞—Ä–∞")
                                .foregroundColor(.white.opacity(0.7))
                            
                            HStack {
                                Picker("–õ–µ–≤–∞—è", selection: $leftCurrency) {
                                    ForEach(availableLeftCurrencies, id: \.self) { Text($0) }
                                }
                                .pickerStyle(MenuPickerStyle())
                                .frame(maxWidth: .infinity)
                                .tint(.white)
                                .onChange(of: leftCurrency) { newLeft in
                                    if rightCurrency == newLeft {
                                        rightCurrency = availableRightCurrencies.first ?? rightCurrency
                                    }
                                }
                                
                                Button(action: {
                                    swap(&leftCurrency, &rightCurrency)
                                }) {
                                    Image(systemName: "arrow.left.arrow.right")
                                        .foregroundColor(.white)
                                        .padding(8)
                                        .background(Color.white.opacity(0.15))
                                        .cornerRadius(8)
                                }
                                
                                Picker("–ü—Ä–∞–≤–∞—è", selection: $rightCurrency) {
                                    ForEach(availableRightCurrencies, id: \.self) { Text($0) }
                                }
                                .pickerStyle(MenuPickerStyle())
                                .frame(maxWidth: .infinity)
                                .tint(.white)
                                .onChange(of: rightCurrency) { newRight in
                                    if leftCurrency == newRight {
                                        leftCurrency = availableLeftCurrencies.first ?? leftCurrency
                                    }
                                }
                            }
                        }
                        
                        VStack(alignment: .leading) {
                            Text("–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ")
                                .foregroundColor(.white.opacity(0.7))
                            Picker("–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", selection: $direction) {
                                Text("‚¨ÜÔ∏è –í–≤–µ—Ä—Ö").tag(Direction.up)
                                Text("‚¨áÔ∏è –í–Ω–∏–∑").tag(Direction.down)
                            }
                            .pickerStyle(SegmentedPickerStyle())
                            .background(Color.white.opacity(0.05))
                            .clipShape(RoundedRectangle(cornerRadius: 8))
                            .colorMultiply(direction == .up ? .green : .red)
                        }
                        
                        VStack(alignment: .leading, spacing: 6) {
                            Text("–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∞")
                                .foregroundColor(.white.opacity(0.7))
                            TextEditor(text: $predictionText)
                                .frame(height: 120)
                                .foregroundColor(.white)
                                .padding(4)
                                .background(Color.clear)
                                .overlay(
                                    RoundedRectangle(cornerRadius: 12)
                                        .stroke(Color.white.opacity(0.2), lineWidth: 1)
                                )
                                .scrollContentBackground(.hidden)
                        }
                        
                        VStack(alignment: .leading) {
                            Text("–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: \(Int(confidence))%")
                                .foregroundColor(.white.opacity(0.7))
                            Slider(value: $confidence, in: 0...100)
                                .accentColor(direction == .up ? .green : .red)
                        }
                        
                        VStack(alignment: .leading, spacing: 6) {
                            Text("–î–∞—Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞")
                                .foregroundColor(.white.opacity(0.7))
                                .frame(maxWidth: .infinity, alignment: .center) // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ —Ü–µ–Ω—Ç—Ä—É, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

                            HStack {
                                Spacer()

                                ZStack {
                                    RoundedRectangle(cornerRadius: 12)
                                        .fill(Color.white.opacity(0.08))

                                    Text(formattedDate)
                                        .foregroundColor(.white)
                                        .padding(.horizontal, 8)
                                        .frame(height: 40)
                                        .frame(maxWidth: .infinity, alignment: .center)
                                }
                                .frame(height: 40)
                                .frame(maxWidth: 250) // –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ —à–∏—Ä–∏–Ω—É, —á—Ç–æ–±—ã –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–æ—Å—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

                                Spacer()
                            }
                        }
                        
                        Button(action: savePost) {
                            Label("–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑", systemImage: "paperplane.fill")
                                .font(.headline)
                                .foregroundColor(.white)
                                .padding()
                                .frame(maxWidth: .infinity)
                                .background(Color.blue)
                                .cornerRadius(14)
                        }
                    }
                    .padding(.horizontal)
                }
                .padding(.top)
            }
            .onAppear { // üëà –î–û–ë–ê–í–õ–ï–ù–û onAppear
                if let user = currentUser {
                    selectedAvatar = user.avatar ?? selectedAvatar
                    selectedStatus = user.status ?? selectedStatus
                }
            }
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .principal) {
                    Text("–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è")
                        .foregroundColor(.white)
                        .font(.headline)
                }
                ToolbarItem(placement: .navigationBarLeading) {
                    Button {
                        presentationMode.wrappedValue.dismiss()
                    } label: {
                        Image(systemName: "chevron.left")
                            .foregroundColor(.white)
                            .padding(8)
                            .background(Color.white.opacity(0.2))
                            .cornerRadius(8)
                    }
                }
            }
            .alert("–ü—Ä–æ–≥–Ω–æ–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!", isPresented: $showConfirmation) {
                Button("–û–∫", role: .cancel) {
                    presentationMode.wrappedValue.dismiss()
                }
            }
        }
    }
    
    private func savePost() {
        guard let user = currentUser else { return }
        
        let post = CDPost(context: viewContext)
        post.id = UUID()
        post.date = date
        post.direction = direction.rawValue
        post.confidence = confidence
        post.predictionText = predictionText
        post.leftCurrency = leftCurrency
        post.rightCurrency = rightCurrency
        post.user = user
        post.avatar = selectedAvatar
        post.status = selectedStatus

        
        do {
            try viewContext.save()
            showConfirmation = true
        } catch {
            print("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: \(error.localizedDescription)")
        }
    }
    
    private func sectionHeader(_ text: String) -> some View {
        Text(text)
            .font(.title3)
            .bold()
            .foregroundColor(.white)
            .frame(maxWidth: .infinity, alignment: .center)
            .padding(.leading, 16)
    }

    private func pickerWithLabel(_ title: String, selection: Binding<String>, options: [String]) -> some View {
        VStack(alignment: .leading, spacing: 6) {
            Text(title)
                .foregroundColor(.white.opacity(0.7))
            Picker(title, selection: selection) {
                ForEach(options, id: \.self) { Text($0) }
            }
            .pickerStyle(MenuPickerStyle())
            .padding()
            .background(Color.white.opacity(0.08))
            .cornerRadius(12)
            .foregroundColor(.white)
        }
        .padding(.horizontal)
    }
}

enum Direction: String, CaseIterable, Identifiable {
    case up, down
    var id: String { rawValue }
}
