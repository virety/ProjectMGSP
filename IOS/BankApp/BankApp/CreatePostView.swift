import SwiftUI

struct CreatePostView: View {
    @Environment(\.presentationMode) var presentationMode
    @Environment(\.colorScheme) var colorScheme
    
    @State private var username: String = "–ï–ª–µ–Ω–∞ –ò–Ω–≤–µ—Å—Ç–æ—Ä"
    @State private var selectedAvatar: String = "üë©‚Äçüíª"
    @State private var selectedStatus: String = "–¢—Ä–µ–π–¥–µ—Ä"
    
    @State private var leftCurrency: String = "EUR"
    @State private var rightCurrency: String = "RUB"
    
    @State private var predictionText: String = ""
    @State private var direction: Direction = .up
    @State private var confidence: Double = 70
    @State private var date: Date = Date()
    @State private var showConfirmation = false
    
    let availableAvatars = ["üë©‚Äçüíª", "üßë‚Äçüíº", "üß†", "üìä", "üíπ"]
    let availableStatuses = ["–¢—Ä–µ–π–¥–µ—Ä", "–ê–Ω–∞–ª–∏—Ç–∏–∫", "–ë—Ä–æ–∫–µ—Ä", "–≠–∫—Å–ø–µ—Ä—Ç"]
    let availableCurrencies = ["USD", "EUR", "RUB", "CNY", "JPY", "GBP"]
    var availableRightCurrencies: [String] {
        availableCurrencies.filter { $0 != leftCurrency }
    }

    var availableLeftCurrencies: [String] {
        availableCurrencies.filter { $0 != rightCurrency }
    }
    var currencyPair: String {
        "\(leftCurrency)/\(rightCurrency)"
    }
    
    var formattedDate: String {
        let formatter = DateFormatter()
        formatter.locale = Locale(identifier: "ru_RU")
        formatter.dateStyle = .long
        return formatter.string(from: date)
    }
    
    var body: some View {
        ZStack {
            LinearGradient(
                gradient: Gradient(colors: [
                    Color(red: 0.06, green: 0.04, blue: 0.15),
                    Color(red: 0.15, green: 0.08, blue: 0.35),
                    Color(red: 0.25, green: 0.13, blue: 0.45)
                ]),
                startPoint: .top,
                endPoint: .bottom
            ).ignoresSafeArea()
            
            ScrollView {
                VStack(spacing: 20) {
                    Group {
                        sectionHeader("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
                        customTextField("–ò–º—è", text: $username)
                        
                        pickerWithLabel("–ê–≤–∞—Ç–∞—Ä", selection: $selectedAvatar, options: availableAvatars)
                        pickerWithLabel("–°—Ç–∞—Ç—É—Å", selection: $selectedStatus, options: availableStatuses)
                    }
                    
                    Group {
                        sectionHeader("–ü—Ä–æ–≥–Ω–æ–∑")
                        
                        VStack(alignment: .leading, spacing: 6) {
                            Text("–í–∞–ª—é—Ç–Ω–∞—è –ø–∞—Ä–∞")
                                .foregroundColor(.white.opacity(0.7))
                            
                            
                            HStack {
                                Picker("–õ–µ–≤–∞—è", selection: $leftCurrency) {
                                    ForEach(availableLeftCurrencies, id: \.self) { Text($0) }
                                }
                                .pickerStyle(MenuPickerStyle())
                                .frame(maxWidth: .infinity)
                                .tint(.white)
                                .onChange(of: leftCurrency) { newLeft in
                                    if rightCurrency == newLeft {
                                        rightCurrency = availableRightCurrencies.first ?? rightCurrency
                                    }
                                }
                                
                                Button(action: {
                                    swap(&leftCurrency, &rightCurrency)
                                }) {
                                    Image(systemName: "arrow.left.arrow.right")
                                        .foregroundColor(.white)
                                        .padding(8)
                                        .background(Color.white.opacity(0.15))
                                        .cornerRadius(8)
                                }
                                
                                Picker("–ü—Ä–∞–≤–∞—è", selection: $rightCurrency) {
                                    ForEach(availableRightCurrencies, id: \.self) { Text($0) }
                                }
                                .pickerStyle(MenuPickerStyle())
                                .frame(maxWidth: .infinity)
                                .tint(.white)
                                .onChange(of: rightCurrency) { newRight in
                                    if leftCurrency == newRight {
                                        leftCurrency = availableLeftCurrencies.first ?? leftCurrency
                                    }
                                }
                            }
                        }
                        
                        VStack(alignment: .leading) {
                            Text("–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ")
                                .foregroundColor(.white.opacity(0.7))
                            Picker("–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", selection: $direction) {
                                Text("‚¨ÜÔ∏è –í–≤–µ—Ä—Ö").tag(Direction.up)
                                Text("‚¨áÔ∏è –í–Ω–∏–∑").tag(Direction.down)
                            }
                            .pickerStyle(SegmentedPickerStyle())
                            .background(Color.white.opacity(0.05))
                            .clipShape(RoundedRectangle(cornerRadius: 8))
                            .colorMultiply(direction == .up ? .green : .red)
                        }
                        
                        VStack(alignment: .leading, spacing: 6) {
                            Text("–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∞")
                                .foregroundColor(.white.opacity(0.7))
                            TextEditor(text: $predictionText)
                                .frame(height: 120)
                                .foregroundColor(.white)
                                .padding(4)
                                .background(Color.clear)
                                .overlay(
                                    RoundedRectangle(cornerRadius: 12)
                                        .stroke(Color.white.opacity(0.2), lineWidth: 1)
                                )
                                .scrollContentBackground(.hidden) // —Å–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ–Ω –≤–Ω—É—Ç—Ä–∏ TextEditor
                        }
                        
                        VStack(alignment: .leading) {
                            Text("–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: \(Int(confidence))%")
                                .foregroundColor(.white.opacity(0.7))
                            Slider(value: $confidence, in: 0...100)
                                .accentColor(direction == .up ? .green : .red)
                        }
                        
                        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π DatePicker –±–µ–∑ –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞
                        VStack(alignment: .leading, spacing: 6) {
                            Text("–î–∞—Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞")
                                .foregroundColor(.white.opacity(0.7))
                            
                            ZStack {
                                RoundedRectangle(cornerRadius: 12)
                                    .fill(Color.white.opacity(0.08))
                                
                                DatePicker(
                                    "",
                                    selection: $date,
                                    displayedComponents: .date
                                )
                                .datePickerStyle(.compact)
                                .labelsHidden()
                                .accentColor(.white)
                                .environment(\.locale, Locale(identifier: "ru_RU"))
                                .colorScheme(.dark)
                                .padding(.horizontal, 8)
                            }
                            .frame(height: 40)
                        }
                        
                        Button(action: {
                            showConfirmation = true
                        }) {
                            Label("–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑", systemImage: "paperplane.fill")
                                .font(.headline)
                                .foregroundColor(.white)
                                .padding()
                                .frame(maxWidth: .infinity)
                                .background(Color.blue)
                                .cornerRadius(14)
                        }
                    }
                    .padding(.horizontal)
                }
                .padding(.top)
            }
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .principal) {
                    Text("–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è")
                        .foregroundColor(.white)
                        .font(.headline)
                }
                ToolbarItem(placement: .navigationBarLeading) {
                    Button {
                        presentationMode.wrappedValue.dismiss()
                    } label: {
                        Image(systemName: "chevron.left")
                            .foregroundColor(.white)
                            .padding(8)
                            .background(Color.white.opacity(0.2))
                            .cornerRadius(8)
                    }
                }
            }
            .alert("–ü—Ä–æ–≥–Ω–æ–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!", isPresented: $showConfirmation) {
                Button("–û–∫", role: .cancel) {
                    presentationMode.wrappedValue.dismiss()
                }
            }
        }
    }
    
    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    private func sectionHeader(_ text: String) -> some View {
        Text(text)
            .font(.title3)
            .bold()
            .foregroundColor(.white)
            .frame(maxWidth: .infinity, alignment: .leading)
            .padding(.leading, 16)
    }
    
    private func customTextField(_ title: String, text: Binding<String>) -> some View {
        VStack(alignment: .leading, spacing: 6) {
            Text(title)
                .foregroundColor(.white.opacity(0.7))
            TextField("", text: text)
                .padding()
                .background(Color.white.opacity(0.08))
                .cornerRadius(12)
                .foregroundColor(.white)
        }
        .padding(.horizontal)
    }
    
    private func pickerWithLabel(_ title: String, selection: Binding<String>, options: [String]) -> some View {
        VStack(alignment: .leading, spacing: 6) {
            Text(title)
                .foregroundColor(.white.opacity(0.7))
            Picker(title, selection: selection) {
                ForEach(options, id: \.self) { Text($0) }
            }
            .pickerStyle(MenuPickerStyle())
            .padding()
            .background(Color.white.opacity(0.08))
            .cornerRadius(12)
            .foregroundColor(.white)
        }
        .padding(.horizontal)
    }
}

enum Direction: String, CaseIterable, Identifiable {
    case up, down
    var id: String { rawValue }
}
